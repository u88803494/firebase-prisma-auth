# 📋 Firebase Auth POC - 需求規格書

> 最後更新：2025-11-18
> 版本：1.0.0

## 📌 項目概述

### 項目目標
快速驗證 Firebase Authentication 與 Next.js 的集成，實現多社群登入系統的 POC。

### 關鍵成果（Key Results）

| KR | 描述 | 完成標準 |
|----|------|--------|
| KR1 | 手機 + 密碼登入可用 | 用戶能成功用手機登入並記錄 Email |
| KR2 | Email + 密碼登入可用 | 用戶能成功用 Email 登入 |
| KR3 | OAuth 登入可用 | Google/Facebook 登入成功，帳號自動關聯 |
| KR4 | 用戶資料持久化 | Firestore 完整存儲用戶資料 |
| KR5 | 系統文檔完整 | 架構文檔、API 規格、部署指南齊全 |

---

## 🎯 功能需求

### FR1：手機 + 密碼認證

#### 詳細需求

| 需求 | 說明 | 優先級 |
|------|------|--------|
| FR1.1 | 用戶能輸入手機號碼 | 必做 |
| FR1.2 | 驗證手機號碼格式（台灣格式） | 必做 |
| FR1.3 | 用戶能輸入密碼 | 必做 |
| FR1.4 | 驗證密碼強度 | 必做 |
| FR1.5 | Backend 將手機映射到 Email | 必做 |
| FR1.6 | Firebase 驗證 Email + 密碼 | 必做 |
| FR1.7 | 成功登入後記錄 Email 到 Firestore | 必做 |
| FR1.8 | 顯示登入錯誤訊息 | 必做 |

#### 驗證標準

```
GIVEN 用戶輸入有效的手機號碼和密碼
WHEN 點擊登入按鈕
THEN
  - 後端成功將手機轉換為 Email
  - Firebase 驗證成功
  - 用戶資料存儲在 Firestore
  - 用戶被重定向到首頁
```

### FR2：Email + 密碼認證

#### 詳細需求

| 需求 | 說明 | 優先級 |
|------|------|--------|
| FR2.1 | 用戶能輸入 Email 地址 | 必做 |
| FR2.2 | 驗證 Email 格式 | 必做 |
| FR2.3 | 用戶能輸入密碼 | 必做 |
| FR2.4 | Firebase 驗證 Email + 密碼 | 必做 |
| FR2.5 | 成功登入後存儲用戶資料 | 必做 |
| FR2.6 | 顯示登入錯誤訊息 | 必做 |

### FR3：Google OAuth 登入

#### 詳細需求

| 需求 | 說明 | 優先級 |
|------|------|--------|
| FR3.1 | 顯示 Google 登入按鈕 | 必做 |
| FR3.2 | 啟動 Google OAuth 流程 | 必做 |
| FR3.3 | 檢查用戶是否已註冊 | 必做 |
| FR3.4 | 已註冊 → 直接登入 | 必做 |
| FR3.5 | 未註冊 → 引導完成資料 | 可選 |
| FR3.6 | 儲存 OAuth 帳號綁定記錄 | 必做 |

### FR4：Facebook OAuth 登入

與 FR3 相同，但改用 Facebook

### FR5：LINE OAuth 登入

#### 詳細需求

| 需求 | 說明 | 優先級 |
|------|------|--------|
| FR5.1 | 顯示 LINE 登入按鈕 | 必做 |
| FR5.2 | 啟動 LINE OAuth 流程 | 必做 |
| FR5.3 | 檢查用戶是否已註冊 | 必做 |
| FR5.4 | 已註冊 → 直接登入 | 必做 |
| FR5.5 | 未註冊 → 引導完成資料 | 可選 |
| FR5.6 | 儲存 LINE 帳號綁定記錄 | 必做 |

#### 驗證標準

```
GIVEN 用戶點擊 LINE 登入按鈕
WHEN LINE 授權完成
THEN
  - 若帳號已存在，直接登入
  - 若帳號不存在，自動建立並登入
  - 用戶資訊正確存儲在 SQLite
  - LINE 帳號信息記錄在 userAuth table
```

### FR6：用戶資料管理

#### SQLite 資料需求

| 欄位 | 類型 | 必填 | 說明 |
|------|------|------|------|
| uid | string | ✅ | Firebase UID（集合主鍵） |
| email | string | ✅ | 用戶 Email |
| phoneNumber | string | ❌ | 手機號碼（手機登入時） |
| displayName | string | ❌ | 顯示名稱 |
| loginMethods | array | ✅ | 登入方式集合 |
| phoneVerified | boolean | ✅ | 手機驗證狀態 |
| emailVerified | boolean | ✅ | Email 驗證狀態 |
| createdAt | timestamp | ✅ | 帳號建立時間 |
| updatedAt | timestamp | ✅ | 最後更新時間 |

### FR7：登出功能

| 需求 | 說明 | 優先級 |
|------|------|--------|
| FR7.1 | 提供登出按鈕 | 必做 |
| FR7.2 | 清除 Firebase 認證狀態 | 必做 |
| FR7.3 | 清除本地 UI 狀態 | 必做 |
| FR7.4 | 重定向到登入頁 | 必做 |

---

## 🔐 非功能需求

### NFR1：安全性

| 需求 | 說明 | 優先級 |
|------|------|--------|
| NFR1.1 | 密碼不存儲明文 | 必做 |
| NFR1.2 | Token 通過 HTTPS 傳輸 | 必做 |
| NFR1.3 | 後端驗證所有 Token | 必做 |
| NFR1.4 | Firestore 規則限制訪問 | 必做 |
| NFR1.5 | 實現 ReCaptcha（可選） | 可選 |

### NFR2：性能

| 需求 | 說明 | 優先級 |
|------|------|--------|
| NFR2.1 | 登入應在 3 秒內完成 | 必做 |
| NFR2.2 | Firebase SDK 最小化 bundle size | 可選 |
| NFR2.3 | 實現 Token 快取 | 可選 |

### NFR3：可用性

| 需求 | 說明 | 優先級 |
|------|------|--------|
| NFR3.1 | 清晰的錯誤訊息 | 必做 |
| NFR3.2 | 支援密碼顯示/隱藏切換 | 必做 |
| NFR3.3 | 支援手機和桌面 | 必做 |

### NFR4：可維護性

| 需求 | 說明 | 優先級 |
|------|------|--------|
| NFR4.1 | 完整的代碼註解 | 必做 |
| NFR4.2 | API 文檔完整 | 必做 |
| NFR4.3 | 清晰的錯誤日誌 | 必做 |

---

## 📊 使用者故事（User Stories）

### US1：用戶用手機號碼登入

```
作為一個已註冊的用戶
我想用手機號碼和密碼登入
以便快速訪問系統

驗收標準：
✓ 輸入有效的台灣手機號碼格式
✓ 輸入正確的密碼
✓ 點擊登入按鈕
✓ 系統驗證身份
✓ 重定向到首頁
✓ 用戶資訊在 Firestore 中正確存儲
```

### US2：用戶用 Email 登入

```
作為一個已註冊的用戶
我想用 Email 和密碼登入
以便訪問系統

驗收標準：
✓ 輸入有效的 Email
✓ 輸入正確的密碼
✓ 點擊登入按鈕
✓ 系統驗證身份
✓ 重定向到首頁
```

### US3：用戶用 Google 帳號登入

```
作為一個新用戶
我想用 Google 帳號登入
以便快速建立帳號

驗收標準：
✓ 看到 Google 登入按鈕
✓ 點擊按鈕啟動 Google OAuth
✓ 在 Google 頁面授權
✓ 返回應用後自動建立帳號
✓ 用戶資訊正確存儲在 Firestore
```

### US4：用戶用 Facebook 帳號登入

與 US3 相同，改用 Facebook

### US5：用戶登出

```
作為一個已登入的用戶
我想能登出
以便安全退出應用

驗收標準：
✓ 看到登出按鈕
✓ 點擊按鈕
✓ 認證狀態被清除
✓ 重定向到登入頁面
```

---

## 🚧 約束條件（Constraints）

### 技術約束

1. **必須使用 Next.js**：App Router
2. **必須使用 Firebase**：不用其他認證服務
3. **必須使用 Firestore**：用戶資料存儲
4. **支援語言**：台灣手機號碼格式
5. **瀏覽器支援**：現代瀏覽器（Chrome、Safari、Firefox）

### 業務約束

1. **工期**：3-5 天（第一階段）
2. **團隊**：1-2 人
3. **預算**：使用 Firebase 免費額度

### 資料約束

1. **密碼長度**：至少 6 字元（Firebase 最小要求）
2. **手機號碼**：台灣格式 (09xx-xxx-xxx 或 10 位數字)
3. **Email**：標準郵件地址格式

---

## 📈 成功指標（Metrics）

### 開發指標

| 指標 | 目標 | 衡量方法 |
|------|------|--------|
| 代碼覆蓋率 | ≥ 80% | Jest/Vitest |
| 類型檢查 | 0 errors | TypeScript |
| Lint errors | 0 errors | ESLint |

### 功能指標

| 指標 | 目標 | 衡量方法 |
|------|------|--------|
| 登入成功率 | ≥ 99% | 測試用例 |
| 登出成功率 | ≥ 99% | 測試用例 |
| 錯誤訊息準確性 | 100% | 手動測試 |

### 性能指標

| 指標 | 目標 | 衡量方法 |
|------|------|--------|
| 首次加載時間 | < 3s | Lighthouse |
| 登入響應時間 | < 2s | 計時測試 |
| Bundle size | < 200KB | build analysis |

---

## 🗺️ 範圍定義

### 包含在內 ✅

- [x] Phone + Password 登入
- [x] Email + Password 登入
- [x] Google OAuth
- [x] Facebook OAuth
- [x] LINE OAuth
- [x] SQLite 用戶資料存儲（Prisma ORM）
- [x] 登出功能
- [x] 錯誤處理
- [x] 基礎 UI/UX

### 不包含在內 ❌
- [ ] 忘記密碼功能（第二階段可選）
- [ ] 二因素認證（2FA）
- [ ] 社交功能（朋友、關注等）
- [ ] 用戶頭像上傳
- [ ] Email 驗證機制
- [ ] 用戶資料編輯功能

---

## 📅 時程規劃

### 第一階段（第 1-5 天）

| 天次 | 任務 | 工期 | 優先級 |
|------|------|------|--------|
| 1 | 項目初始化 + Firebase 配置 | 1 天 | 必做 |
| 2 | Phone + 密碼登入 | 1 天 | 必做 |
| 3 | Email 記錄 + Firestore 設計 | 1 天 | 必做 |
| 4 | Google/Facebook OAuth | 1 天 | 必做 |
| 5 | 前端 UI + 整合測試 | 1-2 天 | 必做 |

### 第二階段（之後）

- LINE OAuth
- 忘記密碼 - Email 驗證
- 忘記密碼 - OTP 驗證
- 記住我功能
- Token 自動更新

---

## 📚 相關文檔

- [討論紀錄](./DISCUSSION_NOTES.md) - 需求背景和決策記錄
- [架構設計](./ARCHITECTURE.md) - 系統架構和技術細節
- [API 規格](./API_SPEC.md) - API 端點和請求/回應格式
- [Firestore 結構](./FIRESTORE_SCHEMA.md) - 資料庫設計

---

_此文檔基於 2025-11-18 的討論_
