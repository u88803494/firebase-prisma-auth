# å¿˜è¨˜å¯†ç¢¼åŠŸèƒ½å®Œæ•´å¯¦ç¾æ–‡ä»¶

## ğŸ“‹ åŠŸèƒ½éœ€æ±‚èªªæ˜

### æ¥­å‹™éœ€æ±‚
å¯¦ç¾ä¸€å€‹å®Œæ•´çš„ã€Œå¿˜è¨˜å¯†ç¢¼ã€åŠŸèƒ½ï¼Œå…è¨±ç”¨æˆ¶é€éå·²è¨»å†Šçš„æ‰‹æ©Ÿè™Ÿç¢¼é‡è¨­å¯†ç¢¼ã€‚

### åŠŸèƒ½æµç¨‹ï¼ˆ3 æ­¥é©Ÿï¼‰
1. **è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼** â†’ ç³»çµ±é©—è­‰è©²è™Ÿç¢¼æ˜¯å¦å·²è¨»å†Š â†’ ç™¼é€ OTP é©—è­‰ç¢¼
2. **è¼¸å…¥ OTP é©—è­‰ç¢¼** â†’ Firebase é©—è­‰ OTP æ­£ç¢ºæ€§
3. **è¨­å®šæ–°å¯†ç¢¼** â†’ æ›´æ–°è³‡æ–™åº«ä¸­çš„å¯†ç¢¼ï¼ˆbcrypt hashï¼‰

### å®‰å…¨æ€§è¦æ±‚
- å¿…é ˆé©—è­‰æ‰‹æ©Ÿè™Ÿç¢¼çš„æ‰€æœ‰æ¬Šï¼ˆé€é Firebase Phone Auth OTPï¼‰
- å¯†ç¢¼å¿…é ˆç¶“é bcrypt hashï¼ˆ10 roundsï¼‰å¾Œå„²å­˜
- åªæœ‰ `phoneVerified: true` çš„ç”¨æˆ¶æ‰èƒ½é‡è¨­å¯†ç¢¼
- å¯†ç¢¼é•·åº¦è‡³å°‘ 6 å€‹å­—å…ƒ

---

## ğŸ” ç¾æœ‰åŠŸèƒ½å®Œæ•´ç‹€æ…‹åˆ†æ

### âœ… å·²å®Œæˆçš„éƒ¨åˆ†

#### 1. å‰ç«¯é é¢ï¼ˆ`src/app/forgot-password/page.tsx`ï¼‰
**ç‹€æ…‹**ï¼šâœ… **å®Œæ•´å¯¦ç¾**

**åŠŸèƒ½åŒ…å«**ï¼š
- 3 æ­¥é©Ÿæµç¨‹æ§åˆ¶ï¼ˆphone â†’ verification â†’ passwordï¼‰
- Firebase Phone Auth æ•´åˆï¼ˆreCAPTCHA + OTP é©—è­‰ï¼‰
- é€²åº¦æŒ‡ç¤ºå™¨è¦–è¦ºåŒ–
- å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶æç¤º
- éŸ¿æ‡‰å¼ UI è¨­è¨ˆ

**UI å…ƒä»¶**ï¼š
- Step 1: æ‰‹æ©Ÿè™Ÿç¢¼è¼¸å…¥è¡¨å–®
- Step 2: OTP é©—è­‰ç¢¼è¼¸å…¥ï¼ˆå«ã€Œè¿”å›ä¿®æ”¹æ‰‹æ©Ÿè™Ÿç¢¼ã€åŠŸèƒ½ï¼‰
- Step 3: æ–°å¯†ç¢¼è¨­å®šè¡¨å–®ï¼ˆå«å¯†ç¢¼ç¢ºèªï¼‰

#### 2. å¾Œç«¯ APIï¼ˆ`src/app/api/auth/reset-password/route.ts`ï¼‰
**ç‹€æ…‹**ï¼šâœ… **å®Œæ•´å¯¦ç¾**

**åŠŸèƒ½åŒ…å«**ï¼š
- æ¥æ”¶æ‰‹æ©Ÿè™Ÿç¢¼å’Œæ–°å¯†ç¢¼
- é©—è­‰ç”¨æˆ¶æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™åº«
- æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å·²é©—è­‰ï¼ˆ`phoneVerified: true`ï¼‰
- ä½¿ç”¨ bcrypt é›œæ¹Šæ–°å¯†ç¢¼ï¼ˆ10 roundsï¼‰
- æ›´æ–°è³‡æ–™åº«ä¸­çš„å¯†ç¢¼æ¬„ä½

**å®‰å…¨é©—è­‰**ï¼š
- âœ… å¿…è¦æ¬„ä½é©—è­‰ï¼ˆphoneNumberã€newPasswordï¼‰
- âœ… å¯†ç¢¼é•·åº¦é©—è­‰ï¼ˆâ‰¥ 6 å­—å…ƒï¼‰
- âœ… ç”¨æˆ¶å­˜åœ¨æ€§æª¢æŸ¥
- âœ… æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰ç‹€æ…‹æª¢æŸ¥

### âš ï¸ ç™¼ç¾çš„å•é¡Œèˆ‡æ”¹å–„å»ºè­°

#### å•é¡Œ 1ï¼šç¼ºå°‘å‰ç½®æ‰‹æ©Ÿè™Ÿç¢¼æª¢æŸ¥
**ç¾æ³**ï¼šå‰ç«¯ç›´æ¥ç™¼é€ OTPï¼Œä¸æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å·²è¨»å†Š

**å½±éŸ¿**ï¼š
- æœªè¨»å†Šçš„æ‰‹æ©Ÿè™Ÿç¢¼ä¹Ÿèƒ½æ”¶åˆ° OTPï¼ˆæµªè²» Firebase é…é¡ï¼‰
- ç”¨æˆ¶é«”é©—ä¸ä½³ï¼ˆOTP é©—è­‰å¾Œæ‰ç™¼ç¾ç„¡æ³•é‡è¨­å¯†ç¢¼ï¼‰

**å»ºè­°æ”¹å–„**ï¼šåœ¨ç™¼é€ OTP å‰ï¼Œå…ˆå‘¼å« API æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å·²è¨»å†Š

#### å•é¡Œ 2ï¼šç¼ºå°‘é‡è¨­å¯†ç¢¼å‰çš„é¡å¤–é©—è­‰
**ç¾æ³**ï¼šOTP é©—è­‰å¾Œç›´æ¥å…è¨±é‡è¨­å¯†ç¢¼

**å®‰å…¨é¢¨éšª**ï¼š
- Firebase OTP é©—è­‰å¾Œå‰ç«¯æœ‰ `confirmationResult`ï¼Œä½†æœªèˆ‡å¾Œç«¯é©—è­‰æµç¨‹é—œè¯
- ç†è«–ä¸Šå¯ä»¥å½é€  API è«‹æ±‚ï¼ˆé›–ç„¶éœ€è¦çŸ¥é“å·²è¨»å†Šçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰

**å»ºè­°æ”¹å–„**ï¼šåœ¨é‡è¨­å¯†ç¢¼ API ä¸­åŠ å…¥ Firebase ID Token é©—è­‰

#### å•é¡Œ 3ï¼šç¼ºå°‘ã€Œæ‰‹æ©Ÿè™Ÿç¢¼å°šæœªé©—è­‰ã€çš„æç¤º
**ç¾æ³**ï¼šå¦‚æœç”¨æˆ¶æ‰‹æ©Ÿè™Ÿç¢¼æœªé©—è­‰ï¼ˆ`phoneVerified: false`ï¼‰ï¼Œå¾Œç«¯æœƒå›å‚³ 403 éŒ¯èª¤

**å½±éŸ¿**ï¼š
- ç”¨æˆ¶å¯èƒ½å›°æƒ‘ç‚ºä½•ç„¡æ³•é‡è¨­å¯†ç¢¼
- æ²’æœ‰å¼•å°ç”¨æˆ¶å…ˆå®Œæˆæ‰‹æ©Ÿé©—è­‰

**å»ºè­°æ”¹å–„**ï¼šå‰ç«¯åŠ å…¥æ›´å‹å–„çš„éŒ¯èª¤æç¤ºï¼Œä¸¦æä¾›é©—è­‰æ‰‹æ©Ÿçš„é€£çµ

---

## ğŸ”§ API è¨­è¨ˆè¦æ ¼

### API 1ï¼šæª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆå¯é¸ï¼Œå»ºè­°æ–°å¢ï¼‰

#### ç«¯é»
```
POST /api/auth/check-phone-for-reset
```

#### è«‹æ±‚æ ¼å¼
```typescript
{
  phoneNumber: string;  // åœ‹éš›æ ¼å¼ï¼Œå¦‚ "+886912345678"
}
```

#### å›æ‡‰æ ¼å¼

**æˆåŠŸ - æ‰‹æ©Ÿè™Ÿç¢¼å·²è¨»å†Šä¸”å·²é©—è­‰**ï¼š
```typescript
{
  success: true,
  exists: true,
  phoneVerified: true
}
```

**æˆåŠŸ - æ‰‹æ©Ÿè™Ÿç¢¼å·²è¨»å†Šä½†æœªé©—è­‰**ï¼š
```typescript
{
  success: true,
  exists: true,
  phoneVerified: false,
  error: "æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªé©—è­‰ï¼Œè«‹å…ˆå®Œæˆé©—è­‰æµç¨‹"
}
```

**æˆåŠŸ - æ‰‹æ©Ÿè™Ÿç¢¼æœªè¨»å†Š**ï¼š
```typescript
{
  success: true,
  exists: false,
  error: "æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªè¨»å†Š"
}
```

**éŒ¯èª¤ - ç¼ºå°‘åƒæ•¸**ï¼š
```typescript
{
  success: false,
  error: "ç¼ºå°‘æ‰‹æ©Ÿè™Ÿç¢¼"
}
// HTTP Status: 400
```

---

### API 2ï¼šé‡è¨­å¯†ç¢¼ï¼ˆç¾æœ‰ï¼Œå»ºè­°å„ªåŒ–ï¼‰

#### ç«¯é»
```
POST /api/auth/reset-password
```

#### è«‹æ±‚æ ¼å¼
```typescript
{
  phoneNumber: string;    // åœ‹éš›æ ¼å¼ï¼Œå¦‚ "+886912345678"
  newPassword: string;    // æ–°å¯†ç¢¼ï¼ˆâ‰¥ 6 å­—å…ƒï¼‰
  idToken?: string;       // ï¼ˆå»ºè­°ï¼‰Firebase ID Tokenï¼ˆç”¨æ–¼é©—è­‰ OTPï¼‰
}
```

#### å›æ‡‰æ ¼å¼

**æˆåŠŸ**ï¼š
```typescript
{
  success: true,
  message: "å¯†ç¢¼é‡è¨­æˆåŠŸ"
}
// HTTP Status: 200
```

**éŒ¯èª¤ - ç¼ºå°‘åƒæ•¸**ï¼š
```typescript
{
  success: false,
  error: "ç¼ºå°‘å¿…è¦åƒæ•¸"
}
// HTTP Status: 400
```

**éŒ¯èª¤ - å¯†ç¢¼å¤ªçŸ­**ï¼š
```typescript
{
  success: false,
  error: "å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ"
}
// HTTP Status: 400
```

**éŒ¯èª¤ - æ‰‹æ©Ÿè™Ÿç¢¼æœªè¨»å†Š**ï¼š
```typescript
{
  success: false,
  error: "æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªè¨»å†Š"
}
// HTTP Status: 404
```

**éŒ¯èª¤ - æ‰‹æ©Ÿè™Ÿç¢¼æœªé©—è­‰**ï¼š
```typescript
{
  success: false,
  error: "æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªé©—è­‰ï¼Œç„¡æ³•é‡è¨­å¯†ç¢¼"
}
// HTTP Status: 403
```

**éŒ¯èª¤ - ä¼ºæœå™¨éŒ¯èª¤**ï¼š
```typescript
{
  success: false,
  error: "å¯†ç¢¼é‡è¨­å¤±æ•—"
}
// HTTP Status: 500
```

---

## ğŸ’» å®Œæ•´å¯¦ç¾æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šæ–°å¢æ‰‹æ©Ÿè™Ÿç¢¼æª¢æŸ¥ APIï¼ˆå»ºè­°ï¼‰

**æª”æ¡ˆè·¯å¾‘**ï¼š`src/app/api/auth/check-phone-for-reset/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

/**
 * æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å¯ç”¨æ–¼å¯†ç¢¼é‡è¨­
 *
 * è«‹æ±‚æ ¼å¼ï¼š
 * POST /api/auth/check-phone-for-reset
 * {
 *   "phoneNumber": "+886912345678"
 * }
 *
 * å›æ‡‰æ ¼å¼ï¼š
 * {
 *   "success": true,
 *   "exists": true,
 *   "phoneVerified": true
 * }
 */
export async function POST(request: NextRequest) {
  try {
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. è§£æè«‹æ±‚è³‡æ–™
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const body = await request.json();
    const { phoneNumber } = body;

    if (!phoneNumber) {
      return NextResponse.json(
        { success: false, error: 'ç¼ºå°‘æ‰‹æ©Ÿè™Ÿç¢¼' },
        { status: 400 }
      );
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. æª¢æŸ¥ Prisma è³‡æ–™åº«
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const user = await prisma.user.findUnique({
      where: { phoneNumber },
      select: {
        id: true,
        phoneVerified: true,
      },
    });

    // æ‰‹æ©Ÿè™Ÿç¢¼æœªè¨»å†Š
    if (!user) {
      return NextResponse.json({
        success: true,
        exists: false,
        error: 'æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªè¨»å†Š',
      });
    }

    // æ‰‹æ©Ÿè™Ÿç¢¼å·²è¨»å†Šä½†æœªé©—è­‰
    if (!user.phoneVerified) {
      return NextResponse.json({
        success: true,
        exists: true,
        phoneVerified: false,
        error: 'æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªé©—è­‰ï¼Œè«‹å…ˆå®Œæˆé©—è­‰æµç¨‹',
      });
    }

    // æ‰‹æ©Ÿè™Ÿç¢¼å·²è¨»å†Šä¸”å·²é©—è­‰ï¼ˆå¯ä»¥é‡è¨­å¯†ç¢¼ï¼‰
    return NextResponse.json({
      success: true,
      exists: true,
      phoneVerified: true,
    });
  } catch (error: any) {
    console.error('âŒ æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼éŒ¯èª¤:', error);

    return NextResponse.json(
      {
        success: false,
        error: error.message || 'æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼å¤±æ•—',
      },
      { status: 500 }
    );
  }
}
```

---

### æ­¥é©Ÿ 2ï¼šå„ªåŒ–å‰ç«¯é é¢ï¼ˆåŠ å…¥å‰ç½®æª¢æŸ¥ï¼‰

**æª”æ¡ˆè·¯å¾‘**ï¼š`src/app/forgot-password/page.tsx`

**ä¿®æ”¹é‡é»**ï¼š
1. åœ¨ç™¼é€ OTP å‰ï¼Œå…ˆå‘¼å« `/api/auth/check-phone-for-reset` æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼
2. æä¾›æ›´å‹å–„çš„éŒ¯èª¤æç¤º
3. æ”¹å–„ç”¨æˆ¶é«”é©—

**é—œéµä¿®æ”¹ä»£ç¢¼**ï¼ˆåœ¨ `handleSendOTP` å‡½å¼é–‹é ­åŠ å…¥ï¼‰ï¼š

```typescript
// Step 1: ç™¼é€ OTPï¼ˆå«å‰ç½®æª¢æŸ¥ï¼‰
const handleSendOTP = async (e: React.FormEvent) => {
  e.preventDefault();
  setError(null);
  setLoading(true);

  try {
    // ğŸ†• å‰ç½®æª¢æŸ¥ï¼šé©—è­‰æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å¯ç”¨æ–¼é‡è¨­å¯†ç¢¼
    const checkRes = await fetch('/api/auth/check-phone-for-reset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phoneNumber }),
    });

    const checkData = await checkRes.json();

    if (!checkData.success) {
      setError(checkData.error || 'æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼å¤±æ•—');
      setLoading(false);
      return;
    }

    // æ‰‹æ©Ÿè™Ÿç¢¼æœªè¨»å†Š
    if (!checkData.exists) {
      setError('æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªè¨»å†Šï¼Œè«‹å…ˆè¨»å†Šå¸³è™Ÿ');
      setLoading(false);
      return;
    }

    // æ‰‹æ©Ÿè™Ÿç¢¼å·²è¨»å†Šä½†æœªé©—è­‰
    if (!checkData.phoneVerified) {
      setError('æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªé©—è­‰ï¼Œç„¡æ³•é‡è¨­å¯†ç¢¼ã€‚è«‹è¯ç¹«å®¢æœæˆ–é‡æ–°è¨»å†Šã€‚');
      setLoading(false);
      return;
    }

    // âœ… æ‰‹æ©Ÿè™Ÿç¢¼æœ‰æ•ˆï¼Œé–‹å§‹ç™¼é€ OTP
    // è¨­ç½® reCAPTCHA
    if (!(window as any).recaptchaVerifier) {
      (window as any).recaptchaVerifier = new RecaptchaVerifier(
        auth,
        'recaptcha-container',
        { size: 'invisible' }
      );
    }

    const appVerifier = (window as any).recaptchaVerifier;
    const result = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
    setConfirmationResult(result);
    setStep('verification');
    setLoading(false);
  } catch (err: any) {
    console.error('âŒ ç™¼é€ OTP éŒ¯èª¤:', err);
    setError(err.message || 'ç™¼é€é©—è­‰ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    setLoading(false);
  }
};
```

---

### æ­¥é©Ÿ 3ï¼šå¾Œç«¯ API ä¿æŒä¸è®Šï¼ˆå·²å®Œæ•´å¯¦ç¾ï¼‰

**æª”æ¡ˆè·¯å¾‘**ï¼š`src/app/api/auth/reset-password/route.ts`

**ç¾æœ‰åŠŸèƒ½å·²å®Œæ•´**ï¼Œç„¡éœ€ä¿®æ”¹ã€‚å¦‚æœæƒ³åŠ å¼·å®‰å…¨æ€§ï¼Œå¯ä»¥è€ƒæ…®åŠ å…¥ Firebase ID Token é©—è­‰ï¼ˆé€²éšåŠŸèƒ½ï¼‰ã€‚

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### æ¸¬è©¦å ´æ™¯ 1ï¼šæ­£å¸¸æµç¨‹

1. **æº–å‚™**ï¼šç¢ºä¿è³‡æ–™åº«ä¸­æœ‰ä¸€å€‹å·²è¨»å†Šä¸” `phoneVerified: true` çš„ç”¨æˆ¶
2. **æ­¥é©Ÿ**ï¼š
   - è¨ªå• `/forgot-password`
   - è¼¸å…¥å·²è¨»å†Šçš„æ‰‹æ©Ÿè™Ÿç¢¼
   - æ”¶åˆ° OTP ç°¡è¨Šï¼Œè¼¸å…¥é©—è­‰ç¢¼
   - è¨­å®šæ–°å¯†ç¢¼
   - å°å‘ç™»å…¥é é¢
3. **é©—è­‰**ï¼šä½¿ç”¨æ–°å¯†ç¢¼æˆåŠŸç™»å…¥

### æ¸¬è©¦å ´æ™¯ 2ï¼šæœªè¨»å†Šçš„æ‰‹æ©Ÿè™Ÿç¢¼

1. **æ­¥é©Ÿ**ï¼šè¼¸å…¥æœªè¨»å†Šçš„æ‰‹æ©Ÿè™Ÿç¢¼
2. **é æœŸçµæœ**ï¼šé¡¯ç¤ºéŒ¯èª¤ã€Œæ­¤æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªè¨»å†Šã€

### æ¸¬è©¦å ´æ™¯ 3ï¼šæœªé©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼

1. **æº–å‚™**ï¼šè³‡æ–™åº«ä¸­æœ‰ç”¨æˆ¶ï¼Œä½† `phoneVerified: false`
2. **æ­¥é©Ÿ**ï¼šè¼¸å…¥è©²æ‰‹æ©Ÿè™Ÿç¢¼
3. **é æœŸçµæœ**ï¼šé¡¯ç¤ºéŒ¯èª¤ã€Œæ‰‹æ©Ÿè™Ÿç¢¼å°šæœªé©—è­‰ï¼Œç„¡æ³•é‡è¨­å¯†ç¢¼ã€

### æ¸¬è©¦å ´æ™¯ 4ï¼šOTP é©—è­‰å¤±æ•—

1. **æ­¥é©Ÿ**ï¼šè¼¸å…¥éŒ¯èª¤çš„ OTP é©—è­‰ç¢¼
2. **é æœŸçµæœ**ï¼šé¡¯ç¤ºéŒ¯èª¤ã€Œé©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèªé©—è­‰ç¢¼æ˜¯å¦æ­£ç¢ºã€

### æ¸¬è©¦å ´æ™¯ 5ï¼šå¯†ç¢¼ä¸ç¬¦

1. **æ­¥é©Ÿ**ï¼šè¼¸å…¥ä¸ä¸€è‡´çš„å¯†ç¢¼å’Œç¢ºèªå¯†ç¢¼
2. **é æœŸçµæœ**ï¼šé¡¯ç¤ºéŒ¯èª¤ã€Œå¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦ã€

### æ¸¬è©¦å ´æ™¯ 6ï¼šå¯†ç¢¼å¤ªçŸ­

1. **æ­¥é©Ÿ**ï¼šè¼¸å…¥å°‘æ–¼ 6 å€‹å­—å…ƒçš„å¯†ç¢¼
2. **é æœŸçµæœ**ï¼šé¡¯ç¤ºéŒ¯èª¤ã€Œå¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒã€

---

## ğŸ” å®‰å…¨æ€§è€ƒé‡

### ç¾æœ‰å®‰å…¨æªæ–½

1. **Firebase Phone Auth OTP é©—è­‰**ï¼šç¢ºä¿æ‰‹æ©Ÿè™Ÿç¢¼çš„æ‰€æœ‰æ¬Š
2. **bcrypt å¯†ç¢¼é›œæ¹Š**ï¼šä½¿ç”¨ 10 rounds é›œæ¹Šæ¼”ç®—æ³•
3. **phoneVerified æª¢æŸ¥**ï¼šåªæœ‰å·²é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼æ‰èƒ½é‡è¨­å¯†ç¢¼
4. **å‰ç½®æ‰‹æ©Ÿè™Ÿç¢¼æª¢æŸ¥**ï¼šé¿å…æµªè²» Firebase é…é¡

### é€²éšå®‰å…¨æªæ–½ï¼ˆå¯é¸ï¼‰

#### 1. åŠ å…¥ Firebase ID Token é©—è­‰ï¼ˆæ¨è–¦ï¼‰

**ç›®çš„**ï¼šç¢ºä¿ OTP é©—è­‰å¾Œçš„è«‹æ±‚ä¾†è‡ªåˆæ³•ç”¨æˆ¶

**å¯¦ç¾æ–¹å¼**ï¼š
- OTP é©—è­‰æˆåŠŸå¾Œï¼Œå–å¾— Firebase User çš„ ID Token
- åœ¨é‡è¨­å¯†ç¢¼ API ä¸­é©—è­‰ ID Token
- ç¢ºä¿ Token ä¸­çš„æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡è«‹æ±‚åƒæ•¸ä¸€è‡´

**ä¿®æ”¹ç¯„ä¾‹**ï¼ˆå¾Œç«¯ APIï¼‰ï¼š

```typescript
import { verifyIdToken } from '@/lib/firebaseAuth';

export async function POST(request: NextRequest) {
  try {
    const { phoneNumber, newPassword, idToken } = await request.json();

    // ğŸ†• é©—è­‰ Firebase ID Tokenï¼ˆå¯é¸ï¼‰
    if (idToken) {
      const decodedToken = await verifyIdToken(idToken);

      if (decodedToken.phone_number !== phoneNumber) {
        return NextResponse.json(
          { success: false, error: 'èº«ä»½é©—è­‰å¤±æ•—' },
          { status: 401 }
        );
      }
    }

    // ... å…¶é¤˜é‚è¼¯ä¿æŒä¸è®Š
  } catch (error) {
    // ...
  }
}
```

#### 2. é™åˆ¶é‡è¨­é »ç‡ï¼ˆæ¨è–¦ï¼‰

**ç›®çš„**ï¼šé˜²æ­¢æƒ¡æ„ç”¨æˆ¶é »ç¹é‡è¨­å¯†ç¢¼

**å¯¦ç¾æ–¹å¼**ï¼š
- åœ¨ User model åŠ å…¥ `lastPasswordResetAt` æ¬„ä½
- é™åˆ¶åŒä¸€ç”¨æˆ¶ 24 å°æ™‚å…§åªèƒ½é‡è¨­ä¸€æ¬¡å¯†ç¢¼

#### 3. è¨˜éŒ„å¯†ç¢¼é‡è¨­æ­·å²ï¼ˆå¯é¸ï¼‰

**ç›®çš„**ï¼šå¯©è¨ˆè¿½è¹¤

**å¯¦ç¾æ–¹å¼**ï¼š
- å»ºç«‹ `PasswordResetLog` model
- è¨˜éŒ„æ¯æ¬¡é‡è¨­çš„æ™‚é–“ã€IP ä½å€ç­‰è³‡è¨Š

---

## ğŸ“Š éŒ¯èª¤è™•ç†å’Œ UX å„ªåŒ–

### ç”¨æˆ¶å‹å–„çš„éŒ¯èª¤è¨Šæ¯

| éŒ¯èª¤å ´æ™¯ | æŠ€è¡“éŒ¯èª¤ | ç”¨æˆ¶å‹å–„è¨Šæ¯ |
|---------|---------|------------|
| æ‰‹æ©Ÿè™Ÿç¢¼æœªè¨»å†Š | `auth/user-not-found` | æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªè¨»å†Šï¼Œè«‹å…ˆè¨»å†Šå¸³è™Ÿ |
| æ‰‹æ©Ÿè™Ÿç¢¼æœªé©—è­‰ | `phoneVerified: false` | æ‰‹æ©Ÿè™Ÿç¢¼å°šæœªé©—è­‰ï¼Œç„¡æ³•é‡è¨­å¯†ç¢¼ |
| OTP é©—è­‰å¤±æ•— | `auth/invalid-verification-code` | é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ |
| å¯†ç¢¼å¤ªçŸ­ | `newPassword.length < 6` | å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ |
| å¯†ç¢¼ä¸ç¬¦ | `newPassword !== confirmPassword` | å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦ï¼Œè«‹é‡æ–°è¼¸å…¥ |
| Firebase é…é¡è¶…é™ | `auth/quota-exceeded` | é©—è­‰ç¢¼ç™¼é€æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦ |

### Loading ç‹€æ…‹

- é¡¯ç¤ºã€Œæª¢æŸ¥ä¸­...ã€ã€ã€Œç™¼é€ä¸­...ã€ã€ã€Œé©—è­‰ä¸­...ã€ã€ã€Œé‡è¨­ä¸­...ã€
- æŒ‰éˆ• disabled ç‹€æ…‹ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š

### é€²åº¦è¦–è¦ºåŒ–

- 3 æ­¥é©Ÿé€²åº¦æ¢ï¼ˆå·²å¯¦ç¾ï¼‰
- å·²å®Œæˆæ­¥é©Ÿé¡¯ç¤ºç¶ è‰²å‹¾å‹¾

---

## ğŸ“ æª”æ¡ˆæ¸…å–®

### éœ€è¦æ–°å¢çš„æª”æ¡ˆ

```
src/app/api/auth/check-phone-for-reset/route.ts  ï¼ˆå»ºè­°æ–°å¢ï¼‰
```

### éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆ

```
src/app/forgot-password/page.tsx  ï¼ˆåŠ å…¥å‰ç½®æª¢æŸ¥ï¼‰
```

### ç„¡éœ€ä¿®æ”¹çš„æª”æ¡ˆ

```
src/app/api/auth/reset-password/route.ts  ï¼ˆå·²å®Œæ•´å¯¦ç¾ï¼‰
```

---

## ğŸš€ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

- [ ] æ–°å¢ `check-phone-for-reset` APIï¼ˆå¦‚æ¡ç”¨å»ºè­°ï¼‰
- [ ] ä¿®æ”¹å‰ç«¯é é¢åŠ å…¥å‰ç½®æª¢æŸ¥
- [ ] å‹åˆ¥æª¢æŸ¥ï¼š`pnpm type-check`
- [ ] Lintingï¼š`pnpm lint`
- [ ] æ¸¬è©¦æ‰€æœ‰ 6 å€‹æ¸¬è©¦å ´æ™¯
- [ ] ç¢ºèª Firebase Phone Auth é…é¡ï¼ˆå…è²»æ–¹æ¡ˆï¼š10 OTP/å¤©ï¼‰
- [ ] ç”Ÿç”¢ç’°å¢ƒï¼šè¨­å®š reCAPTCHA ç¶²åŸŸç™½åå–®
- [ ] ç¢ºèªç’°å¢ƒè®Šæ•¸ï¼š`FIREBASE_SERVICE_ACCOUNT_KEY` æˆ– ADC è¨­å®š

---

## ğŸ“ ç¸½çµ

### ç¾æœ‰åŠŸèƒ½å®Œæ•´åº¦ï¼š90%

**å·²å¯¦ç¾**ï¼š
- âœ… 3 æ­¥é©Ÿå¿˜è¨˜å¯†ç¢¼æµç¨‹ï¼ˆå‰ç«¯ï¼‰
- âœ… Firebase Phone Auth OTP é©—è­‰
- âœ… å¯†ç¢¼é‡è¨­ APIï¼ˆå¾Œç«¯ï¼‰
- âœ… å®‰å…¨å¯†ç¢¼é›œæ¹Šï¼ˆbcrypt 10 roundsï¼‰
- âœ… å®Œæ•´çš„éŒ¯èª¤è™•ç†

**å»ºè­°æ”¹é€²**ï¼š
- ğŸ†• åŠ å…¥å‰ç½®æ‰‹æ©Ÿè™Ÿç¢¼æª¢æŸ¥ï¼ˆé¿å…æµªè²» Firebase é…é¡ï¼‰
- ğŸ†• æ›´å‹å–„çš„éŒ¯èª¤æç¤ºï¼ˆæ‰‹æ©Ÿè™Ÿç¢¼æœªé©—è­‰çš„æƒ…æ³ï¼‰
- ğŸ”’ é€²éšï¼šFirebase ID Token é©—è­‰ï¼ˆå¯é¸ï¼‰
- ğŸ”’ é€²éšï¼šé™åˆ¶é‡è¨­é »ç‡ï¼ˆå¯é¸ï¼‰

### å¯¦ç¾å„ªå…ˆç´š

1. **é«˜å„ªå…ˆç´š**ï¼šæ–°å¢ `check-phone-for-reset` API + ä¿®æ”¹å‰ç«¯é é¢
2. **ä¸­å„ªå…ˆç´š**ï¼šå®Œæ•´æ¸¬è©¦æ‰€æœ‰å ´æ™¯
3. **ä½å„ªå…ˆç´š**ï¼šé€²éšå®‰å…¨æªæ–½ï¼ˆFirebase ID Token é©—è­‰ã€é »ç‡é™åˆ¶ï¼‰

---

**æ–‡ä»¶ç‰ˆæœ¬**ï¼šv1.0
**ç”Ÿæˆæ—¥æœŸ**ï¼š2025-11-21
**é©ç”¨å°è±¡**ï¼šAI åŸ·è¡Œè€…æˆ–é–‹ç™¼äººå“¡
